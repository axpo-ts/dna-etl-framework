name: DNA ETL Package CI/CD

on:
  push:
    branches: ["*"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

env:
  PYTHON_VERSION: "3.11"

jobs:
  test:
    name: Test Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools_scm
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build pytest
        pip install -e .[dev]
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 dna_etl --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 dna_etl --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
    
    - name: Format check with black
      run: black --check dna_etl
    
    - name: Import sort check with isort
      run: isort --check-only dna_etl
    
    - name: Type check with mypy
      run: mypy dna_etl
      continue-on-error: true  # Don't fail build on type errors for now
    
    - name: Test with pytest
      run: pytest
      continue-on-error: true  # Don't fail if no tests exist yet

  build-and-publish:
    name: Build and Publish Package
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools_scm
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools_scm[toml]
    
    - name: Determine version and build type
      id: version
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "Building release version for main branch"
          echo "is_main=true" >> $GITHUB_OUTPUT
          echo "build_type=release" >> $GITHUB_OUTPUT
        else
          echo "Building snapshot version for branch: ${{ github.ref_name }}"
          echo "is_main=false" >> $GITHUB_OUTPUT
          echo "build_type=snapshot" >> $GITHUB_OUTPUT
          # For non-main branches, we'll create a dev version
          branch_name=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/_/g')
          echo "branch_suffix=${branch_name}" >> $GITHUB_OUTPUT
        fi
        
        # Get version from setuptools_scm
        version=$(python -m setuptools_scm)
        echo "version=${version}" >> $GITHUB_OUTPUT
        echo "Package version: ${version}"
    
    - name: Build package
      run: |
        if [[ "${{ steps.version.outputs.is_main }}" == "true" ]]; then
          echo "Building release package"
          python -m build
        else
          echo "Building snapshot package with dev version"
          # For branches, setuptools_scm will automatically create a dev version
          python -m build
        fi
    
    - name: Create version tag (main branch only)
      if: steps.version.outputs.is_main == 'true'
      run: |
        version="${{ steps.version.outputs.version }}"
        # Only create tag if it doesn't exist and we're not already on a tag
        if [[ ! "${{ github.ref }}" =~ ^refs/tags/ ]]; then
          # Extract just the version number (remove any +dev suffixes)
          clean_version=$(echo "$version" | sed 's/+.*//')
          tag_name="v${clean_version}"
          
          # Check if tag already exists
          if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "Creating new tag: $tag_name"
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git tag -a "$tag_name" -m "Release version $clean_version"
            git push origin "$tag_name"
          else
            echo "Tag $tag_name already exists"
          fi
        fi
    
    - name: Upload wheel artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.version.outputs.build_type }}-wheels-${{ steps.version.outputs.version }}
        path: dist/
        retention-days: 30
    
    - name: Display build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ steps.version.outputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Artifacts:" >> $GITHUB_STEP_SUMMARY
        ls -la dist/ >> $GITHUB_STEP_SUMMARY || echo "No dist/ directory found" >> $GITHUB_STEP_SUMMARY

  # Optional: Create GitHub Release for main branch builds
  create-release:
    name: Create GitHub Release
    needs: [test, build-and-publish]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install setuptools_scm
      run: pip install setuptools_scm[toml]
    
    - name: Get version
      id: get_version
      run: |
        version=$(python -m setuptools_scm)
        clean_version=$(echo "$version" | sed 's/+.*//')
        echo "version=${clean_version}" >> $GITHUB_OUTPUT
        echo "tag_name=v${clean_version}" >> $GITHUB_OUTPUT
    
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: release-wheels-${{ steps.get_version.outputs.version }}
        path: dist/
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        release_name: DNA ETL Framework ${{ steps.get_version.outputs.version }}
        body: |
          ## DNA ETL Framework Release ${{ steps.get_version.outputs.version }}
          
          Automated release created from main branch.
          
          ### Changes
          - See commit history for detailed changes
          
          ### Installation
          ```bash
          pip install dna-etl==${{ steps.get_version.outputs.version }}
          ```
        draft: false
        prerelease: false
    
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/
        asset_name: dna-etl-wheels-${{ steps.get_version.outputs.version }}.zip
        asset_content_type: application/zip